# 项目名称：SillyTavern 角色卡自动更新扩展 (AutoCardUpdaterExtension)

**版本号**: 4.0.8

## 项目概述
本扩展旨在通过与自定义AI服务集成，自动分析SillyTavern中的对话历史，并动态生成和更新角色的世界书（Lorebook）条目。这使用户能够捕捉角色在对话中演变的状态、性格和背景，从而在后续的互动中保持角色的一致性和深度。

## 核心功能
1.  **自动更新**: 监听聊天消息，当消息量达到用户设定的阈值时，自动调用AI，根据最近的对话内容生成角色卡，并保存为世界书条目。
2.  **手动更新**: 提供手动触发按钮，允许用户随时根据当前对话内容更新角色卡。
3.  **自定义AI集成**: 用户可以配置自己的OpenAI兼容API（如SillyTavern extras, LM Studio等）的URL、API Key和模型。
4.  **自定义提示词**: 用户可以修改用于破甲和生成角色卡的系统提示词。
5.  **版本自动检查与更新**: 扩展会自动检查GitHub仓库中的新版本，并提示用户一键更新。
6.  **角色卡查看与编辑器**: 提供一个浮动按钮，点击后可打开一个弹窗，用于查看和编辑由本扩展生成的角色卡。

## 角色卡查看与编辑器 (v2.0.0 核心架构重构)
这是查看器的核心功能规划。

### 1. 目标
创建一个集查看、切换和编辑于一体的多角色管理面板，而非仅仅显示当前主角色。

### 2. 数据格式 (v2.0.0 变更)
*   **放弃YAML**: 为了彻底解决解析不可靠的问题，扩展**不再使用YAML**作为数据存储格式。
*   **采用自定义格式**: 所有由AI生成并存储在世界书中的角色卡内容，都使用一种简单的、基于明确标记的 `[key]:value` 格式。这种格式通过点记法路径（如 `traits.0.name`）来表示数据层级，从而消除了由缩进和语法模糊性带来的所有解析问题，确保了100%的数据完整性和可靠性。

### 3. 数据流与逻辑
1.  **打开弹窗 (`showCharCardViewerPopup_ACU`)**:
    *   调用 `TavernHelper_API_ACU.getLorebookEntries()` 获取条目。
    *   **调用新的解析器 (`parseCustomFormat_ACU`)**，将世界书条目中存储的 `[key]:value` 格式文本，精确地转换为供UI使用的JavaScript对象。
2.  **渲染HTML (`createCharCardViewerPopupHtml_ACU`)**:
    *   基于解析后的JavaScript对象，动态、完整地渲染出包含所有模块的编辑器界面。
3.  **事件处理 (`bindCharCardViewerPopupEvents_ACU`)**:
    *   **保存逻辑**:
        *   从UI收集数据，构建成一个JavaScript对象。
        *   **调用新的生成器 (`buildCustomFormat_ACU`)**，将该对象转换回 `[key]:value` 纯文本格式。
        *   调用 `TavernHelper_API_ACU.setLorebookEntries()`，将这种可靠的纯文本格式保存回世界书条目。

## 文件结构
*   `manifest.json`: 扩展元数据，包含版本号、名称等。
*   `index.js`: 扩展的核心逻辑，包括AI调用、事件处理、UI交互等。
*   `style.css`: 扩展的CSS样式，包括设置界面和查看器界面。
*   `settings.html`: 扩展的设置界面HTML结构。
*   `项目文档.txt`: 本文档。

## 版本历史

### v4.0.8 (2025-06-17)
*   **核心机制重构 (纯轮询)**: 根据用户反馈，由于 `tavern_events` 事件系统在某些环境下仍然不可靠，为确保最大兼容性与稳定性，扩展已完全移除所有事件监听逻辑。
*   **可靠性提升**: 扩展现在**完全依赖于一个增强的动态轮询机制**来驱动所有自动更新。
*   **聊天切换检测**: 轮询机制现在足够智能，可以在每次检查时主动获取当前聊天名称，并与内部记录的名称进行比较。如果检测到用户已切换聊天，它会自动重置并加载新聊天的上下文，从而解决了在纯轮询模式下无法响应聊天切换的根本问题。
*   **最终方案**: 此版本是目前最健壮的解决方案，它不依赖任何可能不稳定的事件系统，确保了在所有环境下都能可靠地工作。
*   **版本号更新**: 版本号提升至 4.0.8。

### v4.0.7 (2025-06-17)
*   **事件监听重构 (根本性修复)**: 根据用户提供的 `TavernHelper` API 文档，彻底重构了事件监听逻辑。
*   **API遵从性**: 放弃了旧的、不稳定的 `SillyTavern.eventSource` 重试机制，改为使用官方推荐的 `window.eventOn` 函数和 `window.tavern_events` 对象来订阅事件。
*   **正确性**: 修正了 `CHAT_CHANGED` 事件的监听名称（应为 `chat_id_changed`），并更新了其他相关事件的名称，确保与SillyTavern的事件系统完全兼容。
*   **健壮性**: 新的实现方式从根本上解决了因加载时序问题导致的“无法附加事件监听器”的错误，确保扩展能够稳定、可靠地响应聊天变化，不再依赖于轮询作为后备。
*   **版本号更新**: 版本号提升至 4.0.7。

### v4.0.6 (2025-06-17)
*   **核心初始化修复 (事件监听)**: 彻底修复了因SillyTavern加载时序问题，导致扩展无法监听到 `CHAT_CHANGED` 事件，从而无法正确获取聊天文件名的根本性BUG。
*   **健壮性提升**: 扩展现在会主动、多次尝试挂载事件监听器，直到成功为止。这确保了无论加载顺序如何，扩展都能100%响应聊天切换，并正确管理不同聊天的世界书条目。
*   **版本号统一**: 所有相关文件版本号已统一至 `4.0.6`，以强制SillyTavern加载最新脚本，解决潜在的浏览器缓存问题。

### v4.0.5 (2025-06-17)
*   **聊天切换逻辑修复**: 重写了在聊天加载时处理“人物总览”世界书条目的核心逻辑。
*   **BUG修复**: 解决了因加载时序问题，无法获取当前聊天文件名，导致创建名为 `unknown_chat_init` 的总览条目，并且在切换聊天时无法自动禁用旧条目的严重BUG。
*   **健壮性提升**: 新逻辑会确保在获取到有效的聊天文件名后才继续操作。它会主动禁用所有不属于当前聊天的总览条目，并启用或创建当前聊天的总览条目，彻底解决了条目重复和状态混乱的问题。
*   **版本号更新**: 版本号提升至 4.0.5。

### v4.0.4 (2025-06-11)
*   **正则表达式优化**: 增强了用于提取角色姓名的核心正则表达式，通过启用多行模式（multiline mode），使其能够正确处理AI在返回角色卡数据前可能添加的无关引导文本或换行符。此项修复显著提高了在各种非理想输出场景下的解析成功率。
*   **AI提示词强化**: 进一步强化了AI提示词中的“格式化铁律”，增加了一条新规则，明确禁止在`[START_CHAR_CARD]`和`[END_CHAR_CARD]`块内部出现任何非`[key]:value`格式的文本、空行或注释，以最大限度地约束AI，确保输出数据的纯净性。
*   **提示词版本更新**: 提示词版本号提升至 `4.0.4`，确保所有用户都能通过自动更新机制获得最新的、最健壮的提示词。

### v4.0.3 (2025-06-11)
*   **关键解析器语法修复**: 修复了v4.0.2版本中，为兼容双括号而引入的正则表达式存在语法错误（包含了多余的空格），导致角色卡编辑器 (`Char Card Viewer`) 解析彻底失败，无法读取任何角色信息的严重BUG。
*   **功能恢复**: 修正正则表达式后，编辑器现在可以100%正确地解析存储在世界书中的、包含单括号或双括号的各种角色卡格式，彻底恢复了查看与编辑功能。
*   **版本号更新**: 版本号提升至 4.0.3。

### v4.0.2 (2025-06-11)
*   **编辑器解析器修复**: 修复了角色卡编辑器 (`Char Card Viewer`) 中的解析器 (`parseCustomFormat_ACU`) 未能同步更新以兼容双括号格式 (`[[key]]`) 的严重BUG。
*   **功能恢复**: 此前版本仅修复了数据保存逻辑，导致编辑器无法读取和显示角色卡内容。本次更新后，编辑器已能正确解析并完整显示包含单括号或双括号格式的角色卡，恢复了其核心功能。
*   **版本号更新**: 版本号提升至 4.0.2。

### v4.0.1 (2025-06-11)
*   **关键解析器修复 (AI格式兼容性)**: 修复了因AI模型偶尔返回双重方括号（如 `[[name]]:`）而非标准的单一括号（`[name]:`）格式，导致扩展无法提取角色姓名、更新失败的严重BUG。
*   **健壮性提升**: 增强了用于提取角色姓名的正则表达式，现在可以同时兼容单括号和双括号格式，进一步提高了对AI输出格式微小变化的容忍度，确保了数据解析的稳定性。
*   **版本号更新**: 版本号提升至 4.0.1。

### v4.0.0 (2025-06-11)
*   **核心功能 (强制提示词更新)**: 引入了全新的**提示词版本控制与一次性强制更新机制**。
    *   **实现**: 扩展现在会在加载时检查用户本地存储的提示词版本。如果该版本低于代码中内置的最新版本，扩展会自动、强制性地将用户的角色卡生成提示词更新到最新版。
    *   **目的**: 此功能旨在解决因AI模型迭代或格式优化，导致旧版提示词无法生成符合新要求数据的问题。它确保了所有用户都能无缝过渡到最新的、经过优化的提示词，从而从根本上提高了数据生成的稳定性和准确性。
    *   **用户体验**: 此更新对每个新版本**仅执行一次**，完全不影响用户在更新后对提示词进行的任何自定义修改，保留了用户的自由度。
*   **健壮性与AI指令增强**:
    *   **强化提示词**: 大幅重写并强化了 `DEFAULT_CHAR_CARD_PROMPT_ACU` 中的指令，使用了更明确、更强硬的“格式化铁律”，并更新了示例，以最大限度地降低AI偏离预设格式的概率。
    *   **解析器优化**: 进一步增强了 `proceedWithCardUpdate_ACU` 中用于提取角色姓名的正则表达式，使其能够处理AI可能返回的、包含换行符或其他意外空白字符的复杂情况。
*   **版本号更新**: 版本号提升至 4.0.0，标志着在提示词管理和格式稳定性方面的重大升级。

### v3.9.3 (2025-06-11)
*   **重大解析器健壮性修复**: 根据用户反馈，修复了因AI返回的文本中，冒号（`:`）为全角字符（`：`）或包含不可见空格，导致扩展无法正确解析角色姓名（`name`）字段，从而更新失败的严重BUG。
*   **兼容性增强**: 更新了 `proceedWithCardUpdate_ACU` 函数中的正则表达式，现在可以同时兼容半角和全角冒号，并能自动忽略键与冒号周围的空格。这确保了即使AI输出的格式存在微小偏差，角色卡数据也能被100%正确解析。
*   **版本号更新**: 版本号提升至 3.9.3。

### v3.9.2 (2025-06-11)
*   **关键兼容性修复**: 修复了在某些启动场景下，自动更新检查 (`triggerAutomaticUpdateIfNeeded_ACU`) 运行时，当前角色的上下文（特别是 `context.name2`）尚未完全加载，导致调用 `getCurrentCharPrimaryLorebook()` 时因传入无效参数而抛出 "未找到名为 'null' 的角色卡" 错误的严重BUG。
*   **健壮性提升**: 在调用世界书API之前，增加了对 `context.name2` 是否存在的显式检查。如果角色上下文尚未准备好，将跳过本轮检查，有效避免了因时序问题导致的扩展崩溃。
*   **版本号更新**: 版本号提升至 3.9.2。

### v3.9.1 (2025-06-11)
*   **重大解析器修复 (AI格式校准)**: 根据用户日志反馈，修复了因AI模型未能严格遵守`[key]:value`输出格式（缺少方括号），导致扩展无法识别角色姓名、更新失败的严重BUG。
*   **健壮性提升**: 扩展现在拥有**格式自动校准**能力。在处理AI返回的数据时，会自动为所有缺失方括号的键（如 `name:`）补全为标准格式（如 `[name]:`），确保了即使AI输出存在微小偏差，数据也能被100%正确解析和保存。
*   **版本号更新**: 版本号提升至 3.9.1。

### v3.9.0 (2025-06-11)
*   **重大兼容性修复**: 修复了由于SillyTavern加载时序问题，在初始化时`eventSource`尚未定义，导致扩展中断运行、动态轮询机制无法启动的严重BUG。
*   **健壮性提升**: 初始化逻辑现在更加健壮。即使无法绑定实时事件，扩展也会打印警告并**确保核心的动态轮询机制一定会被启动**，从而完全接管自动更新任务，解决了此前版本在特定加载顺序下完全失效的问题。
*   **版本号更新**: 版本号提升至 3.9.0。

### v3.8.9 (2025-06-11)
*   **核心机制重构 (动态轮询)**: 根据用户反馈，彻底重构了自动更新的触发机制，引入了高度可靠的动态间隔轮询 (`dynamic polling`)。
*   **功能改进**:
    *   **智能间隔**: 轮询从10秒间隔开始检查，如果未触发更新，则检查间隔会自动增加10秒，直至最长100秒，极大地降低了不必要的性能开销。
    *   **即时重置**: 一旦自动更新成功执行，或用户发送新消息、切换聊天，轮询间隔会立即重置回10秒，确保了响应的及时性。
    *   **增强日志**: 整个轮询的生命周期（检查、间隔调整、重置、触发）都会在浏览器开发者控制台（F12）中打印详细日志，方便用户监控其工作状态。
*   **可靠性**: 这个新机制从根本上解决了所有因事件丢失或加载时序问题而导致的更新失效问题，是目前最健壮的解决方案。
*   **版本号更新**: 版本号提升至 3.8.9。

### v3.8.8 (2025-06-11)
*   **重大可靠性修复**: 重写了核心的聊天记录加载函数 (`loadAllChatMessages_ACU`)，以解决在某些情况下（尤其是加载旧聊天时）无法正确获取消息总数，导致自动更新静默失败的严重BUG。
*   **健壮性提升**: 新的加载函数采用主/备多种方式获取消息数量，并增加了详细的调试日志，确保了消息读取的可靠性，并为未来潜在问题的排查提供了便利。
*   **版本号更新**: 版本号提升至 3.8.8。

### v3.8.7 (2025-06-11)
*   **功能修复 (移动端)**: 为角色卡查看器的浮动按钮增加了完整的触摸事件支持 (`touchstart`, `touchmove`, `touchend`)。
*   **改进**: 彻底解决了在移动设备上无法拖动浮动按钮的问题，现在按钮在桌面端和移动端均可自由拖动。
*   **版本号更新**: 版本号提升至 3.8.7。

### v3.8.6 (2025-06-09)
*   **重大UI修复 (移动端)**: 经过多次迭代，最终采用全新的强制性CSS布局策略，彻底解决了在移动端设备上，角色卡查看器弹窗位置不正确、显示不完整或被裁切的问题。
    *   **弹窗布局**: 弹窗现在通过安全的顶部边距进行定位，并仅进行水平居中，放弃了所有在SillyTavern复杂环境中不稳定的垂直居中方案。
    *   **浮动按钮**: 修复了浮动按钮在浏览器窗口大小调整时可能消失的问题，确保其始终在可视范围内。
*   **版本号更新**: 版本号提升至 3.8.6。

### v3.8.4 (2025-06-09)
*   **UI文本优化**: 根据用户反馈，将设置界面中的“功能设置”标题修改为更直观的“更新所有角色描述”，并将“立即更新所有角色描述”的标签简化为“手动更新”。

### v3.8.3 (2025-06-09)
*   **UI布局修复**:
    *   恢复了“功能设置”折叠栏及其全部内容。
    *   在版本信息下方添加了QQ群联系方式。
    *   通过添加更具体的CSS规则，彻底修复了所有按钮（包括设置界面和弹窗内）文字垂直排列的问题。

### v3.8.0 (2025-06-09)
*   **UI风格统一**: 根据用户反馈，完全重写了 `style.css` 文件，精确复制并适配了 `quest-system-extension` 的UI样式。现在，编辑器弹窗和浮动按钮在视觉上与任务系统扩展完全一致，包括颜色、边框、阴影和布局，解决了之前UI不美观和背景透明的问题。
*   **兼容性与健壮性修复**:
    *   **API调用修复**: 更新了事件监听逻辑，使用当前稳定版本的 `SillyTavern.eventSource`，解决了导致扩展崩溃的致命错误。
    *   **解析器增强**: 重写了 `parseCustomFormat_ACU` 函数，使其能够智能处理含有污染性文本的真实世界数据，解决了无法正确显示角色的问题。

### v3.5.0 (2025-06-09)
*   **关键BUG修复**: 修复了在使用 `include_swipes: true` 选项获取上下文时，由于未能正确解析新的消息对象结构（`msg.swipes[msg.swipe_id]`），导致发送给AI的聊天记录内容全部为 `undefined` 的严重问题。现在，扩展已能正确处理两种消息格式，确保上下文的完整性和准确性。

### v3.4.0 (2025-06-09)
*   **日志功能修复**: 根据用户反馈，重写了API请求的日志记录功能。现在，控制台日志将通过 `console.groupCollapsed` 和 `JSON.stringify` 输出一个可折叠、完整且格式化的JSON对象，确保用户可以一字不差地查看和复制最终发送给AI的完整请求体，解决了之前日志信息不完整的问题。

### v3.3.0 (2025-06-09)
*   **核心改进**: 根据用户反馈，优化了上下文获取机制。现在扩展在分析聊天记录时，会调用 `getChatMessages` 并附带 `include_swipes: true` 选项，以确保能够获取到包括所有被替换或未选择的对话分支（swipes）在内的最完整上下文，从而提升AI生成角色卡的准确性和深度。此项更改仅影响本扩展，不改变SillyTavern的全局行为。

### v3.2.0 (2025-06-09)
*   **功能增强**: 新增API请求日志功能。现在，每次调用AI时，都会在浏览器的开发者控制台（F12）中详细打印出完整的请求URL和发送给AI的JSON数据（包含系统提示词和聊天历史），便于用户精确调试和分析上下文层数。
*   **UI回滚**: 根据用户反馈，移除了此前在设置界面添加的关于上下文层数限制的提示，恢复了界面的简洁性。

### v3.1.1 (2025-06-09)
*   **UI优化**: 在“AI读取上下文层数”设置项旁增加了最大值（100）和原因提示，避免用户因不了解SillyTavern平台API的内在限制而产生困惑。

### v3.1.0 (2025-06-09)
*   **多项Bug修复与UI改进**:
    *   **修复更新错误**: 解决了点击“更新”按钮时出现的 "Assignment to constant variable" 错误。
    *   **修复浮动按钮**: 修复了浮动按钮在浏览器窗口大小变化时可能消失的问题。
    *   **修复扩展名称显示**: 通过在 `manifest.json` 中添加 `display_name` 字段，确保扩展在列表中正确显示名称。
    *   **改进UI布局**: 将设置界面中的垂直按钮组修改为水平排列，使其更加美观。

### v3.0.0 (已完成)
*   **最终修复与架构定型**: 本次更新旨在彻底解决v2版本中遗留的UI渲染和数据流问题，是本扩展的最终定型版本。
*   **目标**:
    1.  **重写解析器 (`parseCustomFormat_ACU`)**: 确保解析出的JS对象结构干净、一致，不再进行任何与UI渲染不匹配的重组。
    2.  **重写渲染器 (`createCharCardViewerPopupHtml_ACU`)**: 放弃动态循环渲染，改为对六个核心模块进行独立的、明确的`renderCard`函数调用，为每个模块手动提供正确的数据和路径前缀，从根源上杜绝渲染失败。
    3.  **微调生成器 (`buildCustomFormat_ACU`)**: 确保能正确处理来自新UI的、具有精确`data-path`的数据，并生成完美格式的`[key]:value`文本。
    4.  **完成**: 交付一个功能完整、运行稳定、代码清晰的最终版本。

### v2.0.1 (2025-06-09)
*   **紧急修复**: 修复了 `proceedWithCardUpdate_ACU` 函数中的一个严重bug。该bug导致程序无法正确解析AI使用新格式生成的角色卡，使得“手动更新”功能完全失效。
*   **数据链路完整ity**: 此次修复确保了从AI生成、存入世界书、再到编辑器加载和保存的整个数据链路，都能够统一并正确地处理全新的 `[key]:value` 自定义格式。

### v2.0.0 (2025-06-09)
*   **重大架构重构**: 彻底放弃了使用YAML作为角色卡的数据存储格式，从根源上解决了所有因格式解析不可靠而导致的数据丢失问题。
*   **引入自定义格式**:
    *   **实现**: 设计并启用了一种全新的、基于明确标记的 `[key]:value` 纯文本格式。此格式通过点记法路径（如`traits.0.name`）来清晰地表示数据结构，消除了所有歧义。
    *   **健壮性**: 新格式确保了数据在生成、存储、解析和编辑过程中的100%完整性和可靠性。
*   **核心逻辑重写**:
    *   **提示词**: 完全重写了 `DEFAULT_CHAR_CARD_PROMPT_ACU`，要求AI严格按照新的 `[key]:value` 格式输出，并提供了覆盖全部模块和字段的详尽指令与示例，保证了生成内容的深度和完整性。
    *   **解析器**: 废弃了所有旧的YAML解析代码，重写为全新的 `parseCustomFormat_ACU` 函数，专门用于精确解析新格式。
    *   **生成器**: 废弃了YAML生成逻辑，重写为全新的 `buildCustomFormat_ACU` 函数，用于从UI数据生成新格式的文本以供保存。
*   **用户体验**: 经过此重构，角色卡编辑器的加载和保存功能现在变得极其稳定可靠。
