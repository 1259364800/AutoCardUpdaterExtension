# 项目名称：SillyTavern 角色卡自动更新扩展 (AutoCardUpdaterExtension)

**版本号**: 3.8.4

## 项目概述
本扩展旨在通过与自定义AI服务集成，自动分析SillyTavern中的对话历史，并动态生成和更新角色的世界书（Lorebook）条目。这使用户能够捕捉角色在对话中演变的状态、性格和背景，从而在后续的互动中保持角色的一致性和深度。

## 核心功能
1.  **自动更新**: 监听聊天消息，当消息量达到用户设定的阈值时，自动调用AI，根据最近的对话内容生成角色卡，并保存为世界书条目。
2.  **手动更新**: 提供手动触发按钮，允许用户随时根据当前对话内容更新角色卡。
3.  **自定义AI集成**: 用户可以配置自己的OpenAI兼容API（如SillyTavern extras, LM Studio等）的URL、API Key和模型。
4.  **自定义提示词**: 用户可以修改用于破甲和生成角色卡的系统提示词。
5.  **版本自动检查与更新**: 扩展会自动检查GitHub仓库中的新版本，并提示用户一键更新。
6.  **角色卡查看与编辑器**: 提供一个浮动按钮，点击后可打开一个弹窗，用于查看和编辑由本扩展生成的角色卡。

## 角色卡查看与编辑器 (v2.0.0 核心架构重构)
这是查看器的核心功能规划。

### 1. 目标
创建一个集查看、切换和编辑于一体的多角色管理面板，而非仅仅显示当前主角色。

### 2. 数据格式 (v2.0.0 变更)
*   **放弃YAML**: 为了彻底解决解析不可靠的问题，扩展**不再使用YAML**作为数据存储格式。
*   **采用自定义格式**: 所有由AI生成并存储在世界书中的角色卡内容，都使用一种简单的、基于明确标记的 `[key]:value` 格式。这种格式通过点记法路径（如 `traits.0.name`）来表示数据层级，从而消除了由缩进和语法模糊性带来的所有解析问题，确保了100%的数据完整性和可靠性。

### 3. 数据流与逻辑
1.  **打开弹窗 (`showCharCardViewerPopup_ACU`)**:
    *   调用 `TavernHelper_API_ACU.getLorebookEntries()` 获取条目。
    *   **调用新的解析器 (`parseCustomFormat_ACU`)**，将世界书条目中存储的 `[key]:value` 格式文本，精确地转换为供UI使用的JavaScript对象。
2.  **渲染HTML (`createCharCardViewerPopupHtml_ACU`)**:
    *   基于解析后的JavaScript对象，动态、完整地渲染出包含所有模块的编辑器界面。
3.  **事件处理 (`bindCharCardViewerPopupEvents_ACU`)**:
    *   **保存逻辑**:
        *   从UI收集数据，构建成一个JavaScript对象。
        *   **调用新的生成器 (`buildCustomFormat_ACU`)**，将该对象转换回 `[key]:value` 纯文本格式。
        *   调用 `TavernHelper_API_ACU.setLorebookEntries()`，将这种可靠的纯文本格式保存回世界书条目。

## 文件结构
*   `manifest.json`: 扩展元数据，包含版本号、名称等。
*   `index.js`: 扩展的核心逻辑，包括AI调用、事件处理、UI交互等。
*   `style.css`: 扩展的CSS样式，包括设置界面和查看器界面。
*   `settings.html`: 扩展的设置界面HTML结构。
*   `项目文档.txt`: 本文档。

## 版本历史

### v3.8.6 (2025-06-09)
*   **重大UI修复 (移动端)**: 经过多次迭代，最终采用全新的强制性CSS布局策略，彻底解决了在移动端设备上，角色卡查看器弹窗位置不正确、显示不完整或被裁切的问题。
    *   **弹窗布局**: 弹窗现在通过安全的顶部边距进行定位，并仅进行水平居中，放弃了所有在SillyTavern复杂环境中不稳定的垂直居中方案。
    *   **浮动按钮**: 修复了浮动按钮在浏览器窗口大小调整时可能消失的问题，确保其始终在可视范围内。
*   **版本号更新**: 版本号提升至 3.8.6。

### v3.8.4 (2025-06-09)
*   **UI文本优化**: 根据用户反馈，将设置界面中的“功能设置”标题修改为更直观的“更新所有角色描述”，并将“立即更新所有角色描述”的标签简化为“手动更新”。

### v3.8.3 (2025-06-09)
*   **UI布局修复**:
    *   恢复了“功能设置”折叠栏及其全部内容。
    *   在版本信息下方添加了QQ群联系方式。
    *   通过添加更具体的CSS规则，彻底修复了所有按钮（包括设置界面和弹窗内）文字垂直排列的问题。

### v3.8.0 (2025-06-09)
*   **UI风格统一**: 根据用户反馈，完全重写了 `style.css` 文件，精确复制并适配了 `quest-system-extension` 的UI样式。现在，编辑器弹窗和浮动按钮在视觉上与任务系统扩展完全一致，包括颜色、边框、阴影和布局，解决了之前UI不美观和背景透明的问题。
*   **兼容性与健壮性修复**:
    *   **API调用修复**: 更新了事件监听逻辑，使用当前稳定版本的 `SillyTavern.eventSource`，解决了导致扩展崩溃的致命错误。
    *   **解析器增强**: 重写了 `parseCustomFormat_ACU` 函数，使其能够智能处理含有污染性文本的真实世界数据，解决了无法正确显示角色的问题。

### v3.5.0 (2025-06-09)
*   **关键BUG修复**: 修复了在使用 `include_swipes: true` 选项获取上下文时，由于未能正确解析新的消息对象结构（`msg.swipes[msg.swipe_id]`），导致发送给AI的聊天记录内容全部为 `undefined` 的严重问题。现在，扩展已能正确处理两种消息格式，确保上下文的完整性和准确性。

### v3.4.0 (2025-06-09)
*   **日志功能修复**: 根据用户反馈，重写了API请求的日志记录功能。现在，控制台日志将通过 `console.groupCollapsed` 和 `JSON.stringify` 输出一个可折叠、完整且格式化的JSON对象，确保用户可以一字不差地查看和复制最终发送给AI的完整请求体，解决了之前日志信息不完整的问题。

### v3.3.0 (2025-06-09)
*   **核心改进**: 根据用户反馈，优化了上下文获取机制。现在扩展在分析聊天记录时，会调用 `getChatMessages` 并附带 `include_swipes: true` 选项，以确保能够获取到包括所有被替换或未选择的对话分支（swipes）在内的最完整上下文，从而提升AI生成角色卡的准确性和深度。此项更改仅影响本扩展，不改变SillyTavern的全局行为。

### v3.2.0 (2025-06-09)
*   **功能增强**: 新增API请求日志功能。现在，每次调用AI时，都会在浏览器的开发者控制台（F12）中详细打印出完整的请求URL和发送给AI的JSON数据（包含系统提示词和聊天历史），便于用户精确调试和分析上下文层数。
*   **UI回滚**: 根据用户反馈，移除了此前在设置界面添加的关于上下文层数限制的提示，恢复了界面的简洁性。

### v3.1.1 (2025-06-09)
*   **UI优化**: 在“AI读取上下文层数”设置项旁增加了最大值（100）和原因提示，避免用户因不了解SillyTavern平台API的内在限制而产生困惑。

### v3.1.0 (2025-06-09)
*   **多项Bug修复与UI改进**:
    *   **修复更新错误**: 解决了点击“更新”按钮时出现的 "Assignment to constant variable" 错误。
    *   **修复浮动按钮**: 修复了浮动按钮在浏览器窗口大小变化时可能消失的问题。
    *   **修复扩展名称显示**: 通过在 `manifest.json` 中添加 `display_name` 字段，确保扩展在列表中正确显示名称。
    *   **改进UI布局**: 将设置界面中的垂直按钮组修改为水平排列，使其更加美观。

### v3.0.0 (已完成)
*   **最终修复与架构定型**: 本次更新旨在彻底解决v2版本中遗留的UI渲染和数据流问题，是本扩展的最终定型版本。
*   **目标**:
    1.  **重写解析器 (`parseCustomFormat_ACU`)**: 确保解析出的JS对象结构干净、一致，不再进行任何与UI渲染不匹配的重组。
    2.  **重写渲染器 (`createCharCardViewerPopupHtml_ACU`)**: 放弃动态循环渲染，改为对六个核心模块进行独立的、明确的`renderCard`函数调用，为每个模块手动提供正确的数据和路径前缀，从根源上杜绝渲染失败。
    3.  **微调生成器 (`buildCustomFormat_ACU`)**: 确保能正确处理来自新UI的、具有精确`data-path`的数据，并生成完美格式的`[key]:value`文本。
    4.  **完成**: 交付一个功能完整、运行稳定、代码清晰的最终版本。

### v2.0.1 (2025-06-09)
*   **紧急修复**: 修复了 `proceedWithCardUpdate_ACU` 函数中的一个严重bug。该bug导致程序无法正确解析AI使用新格式生成的角色卡，使得“手动更新”功能完全失效。
*   **数据链路完整ity**: 此次修复确保了从AI生成、存入世界书、再到编辑器加载和保存的整个数据链路，都能够统一并正确地处理全新的 `[key]:value` 自定义格式。

### v2.0.0 (2025-06-09)
*   **重大架构重构**: 彻底放弃了使用YAML作为角色卡的数据存储格式，从根源上解决了所有因格式解析不可靠而导致的数据丢失问题。
*   **引入自定义格式**:
    *   **实现**: 设计并启用了一种全新的、基于明确标记的 `[key]:value` 纯文本格式。此格式通过点记法路径（如`traits.0.name`）来清晰地表示数据结构，消除了所有歧义。
    *   **健壮性**: 新格式确保了数据在生成、存储、解析和编辑过程中的100%完整性和可靠性。
*   **核心逻辑重写**:
    *   **提示词**: 完全重写了 `DEFAULT_CHAR_CARD_PROMPT_ACU`，要求AI严格按照新的 `[key]:value` 格式输出，并提供了覆盖全部模块和字段的详尽指令与示例，保证了生成内容的深度和完整性。
    *   **解析器**: 废弃了所有旧的YAML解析代码，重写为全新的 `parseCustomFormat_ACU` 函数，专门用于精确解析新格式。
    *   **生成器**: 废弃了YAML生成逻辑，重写为全新的 `buildCustomFormat_ACU` 函数，用于从UI数据生成新格式的文本以供保存。
*   **用户体验**: 经过此重构，角色卡编辑器的加载和保存功能现在变得极其稳定可靠。
