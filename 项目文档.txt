# 项目名称：SillyTavern 角色卡自动更新扩展 (AutoCardUpdaterExtension)

**版本号**: 1.3.0

## 项目概述
本扩展旨在通过与自定义AI服务集成，自动分析SillyTavern中的对话历史，并动态生成和更新角色的世界书（Lorebook）条目。这使用户能够捕捉角色在对话中演变的状态、性格和背景，从而在后续的互动中保持角色的一致性和深度。

## 核心功能
1.  **自动更新**: 监听聊天消息，当消息量达到用户设定的阈值时，自动调用AI，根据最近的对话内容生成角色卡，并保存为世界书条目。
2.  **手动更新**: 提供手动触发按钮，允许用户随时根据当前对话内容更新角色卡。
3.  **自定义AI集成**: 用户可以配置自己的OpenAI兼容API（如SillyTavern extras, LM Studio等）的URL、API Key和模型。
4.  **自定义提示词**: 用户可以修改用于破甲和生成角色卡的系统提示词。
5.  **版本自动检查与更新**: 扩展会自动检查GitHub仓库中的新版本，并提示用户一键更新。
6.  **角色卡查看与编辑器**: 提供一个浮动按钮，点击后可打开一个弹窗，用于查看和编辑由本扩展生成的角色卡。

## 角色卡查看与编辑器
这是查看器的核心功能规划。

### 1. 目标
创建一个集查看、切换和编辑于一体的多角色管理面板，而非仅仅显示当前主角色。

### 2. UI/UX 设计 (信息模块化方案)
*   **主布局**: 弹窗顶部是角色选择区，下方是所选角色的信息展示区。
*   **角色选择区**:
    *   动态生成一组按钮，每个按钮显示一个已生成角色卡的**角色姓名**。
    *   默认选中第一个角色。
    *   点击按钮可以切换下方显示的角色信息。
    *   提供一个"刷新"按钮，用于重新从世界书加载角色数据。
*   **信息展示区**:
    *   采用“现代仪表盘”风格，将不同信息放在不同的小卡片（Card）中。
    *   **可编辑字段**: 所有从角色卡中解析出的文本字段都应放在 `<textarea>` 或 `<input>` 中，使其**可以直接编辑**。
    *   **数据绑定**: 每个可编辑的输入框都需要通过 `data-` 属性 (`data-path`) 与原始数据源（世界书条目内容中的字段路径）进行绑定，以便后续保存。
    *   **保存按钮**: 在每个角色的信息展示区底部提供一个“保存对此角色的修改”按钮。

### 3. 数据流与逻辑
1.  **打开弹窗 (`showCharCardViewerPopup_ACU`)**:
    *   调用 `TavernHelper_API_ACU.getLorebookEntries()` 获取当前角色主世界书的所有条目。
    *   通过 `comment` 字段过滤出所有由本扩展生成的角色卡条目。
    *   **为每个条目编写一个解析器**，将YAML格式的 `content` 解析为JavaScript对象，并**保留其`uid`**。
2.  **渲染HTML (`createCharCardViewerPopupHtml_ACU`)**:
    *   接收解析后的角色对象数组作为输入。
    *   根据数组动态生成顶部的角色切换按钮和下方所有角色的信息卡片。
    *   确保所有字段都渲染为可编辑的输入框，并绑定好 `data-` 属性。
3.  **事件处理 (`bindCharCardViewerPopupEvents_ACU`)**:
    *   **切换逻辑**: 为顶部的角色按钮绑定点击事件，用于显示/隐藏对应角色的信息面板。
    *   **保存逻辑**:
        *   为“保存”按钮绑定点击事件。
        *   触发后，根据当前显示的角色的 `uid`，读取页面上所有属于该角色的输入框的值。
        *   **重新构建**符合格式的YAML字符串。
        *   调用 `TavernHelper_API_ACU.setLorebookEntries()`，使用 `uid` 来精确更新被修改的条目。
        *   向用户显示保存成功的提示。

## 文件结构
*   `manifest.json`: 扩展元数据，包含版本号、名称等。
*   `index.js`: 扩展的核心逻辑，包括AI调用、事件处理、UI交互等。
*   `style.css`: 扩展的CSS样式，包括设置界面和查看器界面。
*   `settings.html`: 扩展的设置界面HTML结构。
*   `CHANGELOG.md`: 版本更新日志。
*   `项目文档.txt`: 本文档。

## 版本历史

### v1.3.0 (2025-06-09)
*   **重大修复/重构**: 彻底重写了角色卡编辑器的UI渲染和保存逻辑，修复了其核心功能。
*   **UI渲染 (`createCharCardViewerPopupHtml_ACU`)**:
    *   **修复**: 解决了UI中字段重复渲染的Bug。
    *   **优化**: 使用统一的渲染函数，确保所有六个模块（外显、内质、外延、特质、语料、关系）都能正确、一致地显示。
    *   **优化**: 改进了对复杂列表（如核心特质）和简单列表（如标签）的HTML结构生成。
*   **保存功能 (`buildYamlString_ACU`)**:
    *   **修复**: 修复了因逻辑错误导致保存功能完全失效的严重Bug。
    *   **实现**: 实现了从UI表单中正确收集所有字段（包括简单值、多行文本、简单列表和复杂对象列表）数据的逻辑。
    *   **实现**: 实现了健壮的YAML字符串生成器，能够根据收集到的数据，精确地构建出格式完全正确的YAML，确保保存功能可靠。
*   **健壮性**: 大幅提升了编辑器处理复杂数据结构的能力，提高了稳定性和用户体验。
